import { Clipboard, showToast, Toast } from "@raycast/api";
import { showFailureToast } from "@raycast/utils";
import { generateMermaidDiagram } from "../utils/diagram";
import { cleanupTempFile } from "../utils/files";
import { promisify } from "util";
import { exec } from "child_process";
import { pathToFileURL } from "url";
import fs from "fs";

const execPromise = promisify(exec);

/**
 * Define the input parameters required by the AI tool
 */
type MermaidToolInput = {
  /**
   * A complete and valid Mermaid syntax string that needs to be converted into an image.
   * This is usually generated by the AI at user request, or provided directly by the user.
   * For example: 'graph TD\\nA --> B' or 'sequenceDiagram\\nAlice->>Bob: Hi!'
   */
  mermaidSyntax: string;
};

/**
 * Copies an image to the clipboard based on the file format
 */
async function copyImageToClipboard(imagePath: string, format: string): Promise<void> {
  if (format === "svg") {
    const svgContent = fs.readFileSync(imagePath, "utf-8");
    await Clipboard.copy(svgContent);
  } else {
    // For PNG format
    await execPromise(`osascript -e 'set the clipboard to (read (POSIX file "${imagePath}") as TIFF picture)'`);
  }
}

/**
 * @raycast AI Tool
 * @name generateMermaidImageTool
 * @description Generates a Mermaid diagram image from the provided syntax and returns **ready-to-display markdown**. The tool outputs markdown that already includes the image reference, so the AI must **output the returned value exactly as-is** without modification. Do NOT call this tool multiple times for the same diagram. The image is automatically copied to the clipboard.
 * @param {MermaidToolInput} input - The object containing the `mermaidSyntax` field.
 * @returns {Promise<string>} - Ready-to-display markdown containing the diagram image (e.g., `![Mermaid Diagram](file://...)`). Output this exactly as returned.
 */
export default async function generateMermaidImageTool(input: MermaidToolInput): Promise<string> {
  const { mermaidSyntax } = input;

  // Input validation - throw error instead of returning error message
  if (!mermaidSyntax?.trim()) {
    console.error("AI Tool called with invalid syntax:", mermaidSyntax);
    throw new Error("Mermaid syntax was not provided or is empty. Cannot generate diagram.");
  }

  console.log("AI Tool 'generateMermaidImageTool' called with syntax:", mermaidSyntax);
  const tempFileRef = { current: null as string | null };
  let outputImagePath: string | null = null;

  try {
    // Create a single toast that we'll update throughout the process
    const toast = await showToast({
      style: Toast.Style.Animated,
      title: "Generating diagram...",
    });

    // Generate the diagram (force PNG format for AI chat compatibility)
    outputImagePath = await generateMermaidDiagram(mermaidSyntax, tempFileRef, "png");

    // Update toast to show progress
    toast.title = "Copying image to clipboard...";

    // Copy to clipboard (PNG format)
    await copyImageToClipboard(outputImagePath, "png");

    // Update toast to show success
    toast.style = Toast.Style.Success;
    toast.title = "Diagram generated and copied";

    // Convert file path to file URL and return ready-to-display markdown
    const fileUrl = pathToFileURL(outputImagePath).toString();
    return `![Mermaid Diagram](${fileUrl})`;
  } catch (error) {
    console.error("AI tool execution failed:", error);
    const errorMessage = error instanceof Error ? error.message : String(error);

    await showFailureToast(error, {
      title: "Failed to generate diagram",
      message: errorMessage,
    });

    // Throw error instead of returning error message string
    throw new Error(`Diagram generation failed: ${errorMessage}. Please check if the Mermaid syntax is correct.`);
  } finally {
    // Clean up only the temporary .mmd file, keep the generated image
    if (tempFileRef.current) {
      cleanupTempFile(tempFileRef.current);
      console.log("Cleaned temporary .mmd file:", tempFileRef.current);
    }
    // Note: outputImagePath is NOT cleaned up - images are kept permanently in
    // ~/Downloads/MermaidDiagrams/
  }
}
