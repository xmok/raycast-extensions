import { showToast, Toast, open, getPreferenceValues } from "@raycast/api";
import { showFailureToast } from "@raycast/utils";
import { generateMermaidDiagram } from "../utils/diagram";
import { cleanupTempFile } from "../utils/files";
import { promisify } from "util";
import { exec } from "child_process";
import { pathToFileURL } from "url";
import { Preferences } from "../types";

const execPromise = promisify(exec);
/**
 * Define the input parameters required by the AI tool
 */
type MermaidToolInput = {
  /**
   * A complete and valid Mermaid syntax string that needs to be converted into an image.
   * This is usually generated by the AI at user request, or provided directly by the user.
   * For example: 'graph TD\\nA --> B' or 'sequenceDiagram\\nAlice->>Bob: Hi!'
   */
  mermaidSyntax: string;
};
/**
 * Copies an image to the clipboard based on the file format
 */
async function copyImageToClipboard(imagePath: string): Promise<void> {
  await execPromise(`osascript -e 'set the clipboard to (read (POSIX file "${imagePath}") as TIFF picture)'`);
}

/**
 * @raycast AI Tool
 * @name generateMermaidImageTool
 * @description Generates a Mermaid diagram and opens in Preview
 * @param {object} input - Tool input
 * @param {string} input.mermaidSyntax - Mermaid syntax
 * @returns {Promise<string>} - Success message with preview link
 */
export default async function generateMermaidImageTool(input?: MermaidToolInput): Promise<string> {
  const mermaidSyntax = input?.mermaidSyntax;

  if (!mermaidSyntax?.trim()) {
    throw new Error("Mermaid syntax was not provided or is empty.");
  }

  const tempFileRef = { current: null as string | null };

  try {
    const toast = await showToast({
      style: Toast.Style.Animated,
      title: "Generating diagram...",
    });

    // Generate high-quality image
    const preferences = getPreferenceValues<Preferences>();
    const rawScale = preferences.scale;
    const parsedScale = typeof rawScale === "number" ? rawScale : Number(rawScale);
    const finalScale = Number.isFinite(parsedScale) && parsedScale > 0 ? parsedScale : 2;

    const outputPath = await generateMermaidDiagram(mermaidSyntax, tempFileRef, "png", {
      scale: finalScale,
      width: 2400,
    });

    // Copy to clipboard
    await copyImageToClipboard(outputPath);

    // Auto-open in Preview
    await open(outputPath, "com.apple.Preview");

    toast.style = Toast.Style.Success;
    toast.title = "Diagram ready!";

    // Create file URL for the link
    const fileUrl = pathToFileURL(outputPath).toString();

    // Return minimal message with link
    return `Mermaid diagram generated successfully.

**Full size:** [Open in Preview](${fileUrl})`;
  } catch (error) {
    console.error("Diagram generation failed:", error);
    const errorMessage = error instanceof Error ? error.message : String(error);

    await showFailureToast(error, {
      title: "Failed to generate diagram",
      message: errorMessage,
    });

    throw new Error(`Diagram generation failed: ${errorMessage}`);
  } finally {
    if (tempFileRef.current) {
      cleanupTempFile(tempFileRef.current);
    }
  }
}
